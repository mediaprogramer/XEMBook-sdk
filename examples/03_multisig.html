<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>テスト</title>

<script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.9-1/crypto-js.min.js"></script>

<script src="xembook-sdk.js"></script>
<script src="nacl-fast.js"></script>
<script src="keyPair.js"></script>

<link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css" />
<script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>

<script>


//送金API URL
var URL_TRANSACTION_ANNOUNCE = "http://beny.supernode.me:7890/transaction/announce";



$(function(){


	$('#btnAddSigner').on('click', function (event) {

		$('#modal1').modal();
		$('#modal1_title').text("追加する署名者アドレスを入力してください");

	});

	$(document).on("click","#show_privatekey", function() {

		$('#modal2').modal();
		$('#modal2_label').text($(this).data('num'));
		return false;
	});

	//非表示時にはお掃除
	$('#modal2').on('hidden.bs.modal', function () {
		$('#modal2_label').text("XXXXXXXXXXXXXXXXXXXXX");
	})
	
	$("#modal1_confirm").on("click",function(event){

		var addr4 = $("#modal1_form").val().replace( /-/g , "" ).toUpperCase();

		$.ajax({url: "http://beny.supernode.me:7890/account/get?address=" + addr4 ,type: 'GET'}
		).done(
			function(res){
				console.log(res);
				console.log(res.account);
				console.log(res.account.publicKey);

				let timeStamp = Math.floor((Date.now() / 1000) - (NEM_EPOCH / 1000));
				let due = 60;

				let data ={
					'type': multisigModification,
					'version': getVersion(2,104),
					'signer': k.publicKey.toString(),
					'timeStamp': timeStamp,
					'deadline' : timeStamp + due * 60
				};

				let custom = {
					'fee': 500000,
					"modifications": [
						{"modificationType": 1,"cosignatoryAccount": res.account.publicKey,"cosignatoryAddress": addr4},
					],
					"minCosignatories" : {"relativeChange": 1}
				};

				let entity = $.extend(data, custom);
				let result = serializeTransaction(entity);
				let signature = k.sign(result);
				let obj = {'data':ua2hex(result), 'signature':signature.toString()};

				console.log(entity);
				console.log(obj);
				console.log(JSON.stringify(entity));

				$.ajax({
					url: "http://beny.supernode.me:7890/transaction/announce"  ,
					type: 'POST',
					contentType:'application/json',
					data: JSON.stringify(obj)  ,
					error: function(XMLHttpRequest) {
						console.log( $.parseJSON(XMLHttpRequest.responseText));
					}
				}).done(
				function(data){
					console.log(data);
				});

				
			}
		);

	});

	var sk = Array();
	sk[0] = nacl.randomBytes(32);
	
	var s = nacl.randomBytes(32);
	var k = KeyPair.create(s);
	var addr = toAddress(k.publicKey.toString(), "104");

	var bill = '{"v":2,"type":2,"data":{"addr":"' + addr + '","amount":1000000,"msg":""}}';
	$("#receiverqr").attr("src","http://chart.apis.google.com/chart?chs=180x180&cht=qr&chl=" + bill);
	$("#asset_qr").text(addr);

	//未承認チェック開始
	var unconf_check = setInterval(function polling(){

		console.log("start!");
		$.ajax({url: "http://beny.supernode.me:7890/account/unconfirmedTransactions?address=" + addr ,type: 'GET'}
		).done(
			function(res){parse_unconfirm(res)}
		);
		return polling;

	}(),3000);


	//未承認チェック
	var parse_unconfirm = function(result){

		var dataArray = result.data;
		dataArray.some(function(val){

			//未承認チェック終了
			clearInterval(unconf_check);

			var tran = val.transaction;

			var $modal = $('.js-loading-bar');
			var $bar = $modal.find('.progress-bar');

			progress(count);
			$modal.modal('show');

			//承認チェック開始
			conf_check = setInterval(function(){

				console.log("start:conf_check");
				$.ajax({url: "http://beny.supernode.me:7890/account/get?address=" + addr ,type: 'GET'}
				).done(
					function(res){parse_transfers(res)}
				);

			},3000);
		});
	};


	var parse_transfers = function(result){

		console.log(result);
		var balance = result.account.balance;
		if(balance > 0){

			clearInterval(conf_check);

			is_confirmed=true;
			ticker = 50;
			incr = 20;

			console.log(toAddress(k.publicKey.toString(), "104"));

			var s1 = nacl.randomBytes(32);
			var k1 = KeyPair.create(s1);
			console.log(toAddress(k1.publicKey.toString(), "104"));

			var s2 = nacl.randomBytes(32);
			var k2 = KeyPair.create(s2);
			console.log(toAddress(k2.publicKey.toString(), "104"));

			var s3 = nacl.randomBytes(32);
			var k3 = KeyPair.create(s3);
			console.log(toAddress(k3.publicKey.toString(), "104"));

			$( "#cosigners tbody" ).append( "<tr>" +
				"<td>所有者</td>" +
				"<td>" + toAddress(k1.publicKey.toString(), "104") + "</td>" +
				"<td>本人用(<a href='#' id='show_privatekey' data-num='1'>秘密鍵</a>)</a></td>" +
			"</tr>" );
			$( "#cosigners tbody" ).append( "<tr>" +
				"<td>所有者</td>" +
				"<td>" + toAddress(k2.publicKey.toString(), "104") + "</td>" +
				"<td>緊急時用(秘密鍵)</td>" +
			"</tr>" );
			$( "#cosigners tbody" ).append( "<tr>" +
				"<td>所有者</td>" +
				"<td>" + toAddress(k3.publicKey.toString(), "104") + "</td>" +
				"<td><button id='btnReset'>譲渡</button></td>" +
			"</tr>" );
			$('#cosigners-ctrl').collapse('show');

			let timeStamp = Math.floor((Date.now() / 1000) - (NEM_EPOCH / 1000));
			let due = 60;
	
			let data ={
				'type': multisigModification,
				'version': getVersion(2,104),
				'signer': k.publicKey.toString(),
				'timeStamp': timeStamp,
				'deadline': timeStamp + due * 60
			};

			let custom = {
				'fee': 500000,
				"modifications": [
					{"modificationType": 1,"cosignatoryAccount": k1.publicKey.toString(),"cosignatoryAddress": toAddress(k1.publicKey.toString(), "104")},
					{"modificationType": 1,"cosignatoryAccount": k2.publicKey.toString(),"cosignatoryAddress": toAddress(k2.publicKey.toString(), "104")},
					{"modificationType": 1,"cosignatoryAccount": k3.publicKey.toString(),"cosignatoryAddress": toAddress(k3.publicKey.toString(), "104")}
				],
				"minCosignatories" : {"relativeChange": 2}
			};

			let entity = $.extend(data, custom);
			let result = serializeTransaction(entity);
			let signature = k.sign(result);
			let obj = {'data':ua2hex(result), 'signature':signature.toString()};

			console.log(entity);
			console.log(obj);
			console.log(JSON.stringify(entity));

			$.ajax({
				url: "http://beny.supernode.me:7890/transaction/announce"  ,
				type: 'POST',
				contentType:'application/json',
				data: JSON.stringify(obj)  ,
				error: function(XMLHttpRequest) {
					console.log( $.parseJSON(XMLHttpRequest.responseText));
				}
			}).done(
			function(data){
				console.log(data);
			});
		}
	};




	console.log(s);
	console.log(k);
	console.log(addr);
	$( "#cosigners tbody" ).append( "<tr>" +
		"<td>マルチシグ</td>" +
		"<td>" +addr + "</td>" +
		"<td>(開発中)</td>" +
	"</tr>" );

	function sendTransferRequest(){

		var result = confirm("送金します。本当によろしいですか？");
		if(result){
			sendAjaxRequest().done(
			function(data){
				console.log(data);
			});
		}
	}
	$("#btnReset").click(function(){sendTransferRequest();return false;});
	
	var count = 0;
	var ticker = 600;
	var is_confirmed = false;
	var incr = 1;

	function progress(count){
		setTimeout(function(){
			var $modal = $('.js-loading-bar');
			count+=incr;
			if(count >= 90 && is_confirmed == false) {
				count = 90;
			}

			if(is_confirmed) {

				//プログレスバー終了
				$modal.find('.progress-bar').css({'width':'100%'});
				setTimeout(function() { $modal.modal('hide').delay(800).queue(function(next) {next();});},1600);
				return;
			}

			$modal.find('.progress-bar').css({'width':count+'%'});
			progress(count);

		},normRand(ticker, 50));
	}

	//ランダム正規分布(m=中央値,s=偏り)
	var normRand = function (m, s) {
		var a = 1 - Math.random();
		var b = 1 - Math.random();
		var c = Math.sqrt(-2 * Math.log(a));
		if(0.5 - Math.random() > 0) {
			return c * Math.sin(Math.PI * 2 * b) * s + m;
		}else{
			return c * Math.cos(Math.PI * 2 * b) * s + m;
		}
	};
	
	
});

</script>
</head>
<body>

<h1>マルチシグジェネレータ</h1>
<!-- <button id="btnReset">submit</button> -->
<br>
<img id="receiverqr" src="" alt="" width="180" height="180">
<div id="asset_qr"></div>

<div class="collapse" id="cosigners-ctrl">
	<table  class="table" id="cosigners">
		<thead><tr><th>区分</th><th>アドレス</th><th>操作</th></tr></thead>
		<tbody></tbody>
	</table>
<button id="btnAddSigner">署名者の追加</button>
</div>

<!-- <button id="load">Load It!</button> -->
<div class="modal js-loading-bar">
 <div class="modal-dialog">
   <div class="modal-content">
     <div class="modal-body">
       <div class="progress progress-popup">
        <div class="progress-bar progress-bar-striped active"></div>
       </div>
        <div>トランザクション確認中</div>
     </div>
   </div>
 </div>
</div>

 <!-- モーダル・ダイアログ -->
<div class="modal fade" id="modal1" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
        <h4 class="modal-title" id="modal1_title"></h4>
      </div>
      <div class="modal-body">
        <form class="form-horizontal" >
          <div class="form-group">
            <label class="col-sm-2 control-label">Addresss</label><div class="col-sm-10"><input type="text" class="form-control" id="modal1_form" ></div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">キャンセル</button>
        <button type="button" class="btn btn-primary" data-dismiss="modal"  id="modal1_confirm">OK</button>
      </div>
    </div>
  </div>
</div>

 <!-- モーダル・ダイアログ -->
<div class="modal fade" id="modal2" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
        <h4 class="modal-title" id="modal2_title">秘密鍵</h4>
      </div>
      <div class="modal-body">
        <form class="form-horizontal" >
          <div class="form-group">
            <label class="col-sm-12 control-label" id="modal2_label">XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX</label>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">キャンセル</button>
        <button type="button" class="btn btn-primary" data-dismiss="modal"  id="modal1_confirm">OK</button>
      </div>
    </div>
  </div>
</div>

</body>
</html>
